#!/bin/sh
# See the LICENSE file for copyright and license details.

FUNCPATH="./func"
VERSION="git"

usage() {
	cat <<EOF
${0##*/} [options]

  Options:
    -d      Use the default configuration
    -n      Print to stdout instead of the bar
    -x      Kill existing sb instance
    -h      Print this help and exit
    -v      Print version number and exit

${0##*/}-$VERSION
2019-2020 (c) Cem Keylan
EOF
exit 1
}

while [ "$1" ] ; do case "$1" in 
    -d) noconfig=1 ; shift ;;
    -v) printf '%s\n' "${0##*/}-$VERSION"; exit 0 ;; 
    -n) nobar=1 ; shift ;; 
    -x) ! [ -e "/tmp/sb-$USER.pid" ] && \
    	printf "There is no running instance of sb\\n" && exit 1
    kill "$(cat "/tmp/sb-$USER.pid")"; rm "/tmp/sb-$USER.pid"; exit 0 
    ;; 
    *) usage ;;
esac ; done


[ "$noconfig" ] || { [ -e "$HOME/.config/sbrc" ] && . "$HOME/.config/sbrc" ;}
[ "$DELIMITER" ] || DELIMITER="|"
[ "$SLEEPTIME" ] || SLEEPTIME="1"

# Load Functions
for func in "$FUNCPATH/"* ; do [ -f "$func" ] && . "$func"; done
for func in "$HOME/.config/sb-func/"* ; do [ -f "$func" ] && . "$func" ; done

# Unless running from the command line, check for
# an existing instance
[ "$nobar" ] || { [ -e "/tmp/sb-$USER.pid" ] && {
	[ -z "$KILLEXISTING" ] && printf 'ERROR: sb is already running\nIf you think otherwise, remove /tmp/sb-%s$.pid manually.\n' "$USER" && exit 1
	kill "$(cat "/tmp/sb-$USER.pid")" 2>/dev/null ;}
	printf '%s\n' "$$" > "/tmp/sb-$USER.pid" ;}

command -v bar >/dev/null 2>&1 || bar() { storage ; ram ; gethostname ; datetime ;}

[ -z "$nobar" ] && while true; do xsetroot -name " $(bar)"; sleep "$SLEEPTIME"; done && exit 0
while true; do clear ; bar; sleep "$SLEEPTIME"; done
